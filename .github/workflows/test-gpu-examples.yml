name: Build and run GPU integrated tests (examples)

on:
  workflow_dispatch:
  push:
    branches: ["*"]
  pull_request:
    branches: ["master", "main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  BPFTIME_VM_NAME: llvm

jobs:
  build-and-test-gpu-examples:
    runs-on: [self-hosted, Linux, X64, gpu]
    strategy:
      fail-fast: false
      matrix:
        examples:
          - path: kernelretsnoop
            executable: ./kernelretsnoop
            victim: ./vec_add
            expected_str: "Thread ("
            name: kernelretsnoop
            server_timeout: 15
          - path: threadhist
            executable: ./threadhist
            victim: ./vec_add
            expected_str: "Thread "
            name: threadhist
            server_timeout: 15
          - path: cuda-counter
            executable: ./cuda_probe
            victim: ./vec_add
            expected_str: "Entered _Z9vectorAddPKfS0_Pf"
            name: cuda-counter
            server_timeout: 15
          - path: launchlate
            executable: ./launchlate
            victim: ./vec_add
            expected_str: "Monitoring CUDA kernel launch latency"
            name: launchlate
            server_timeout: 15
          - path: mem_trace
            executable: ./mem_trace
            victim: ./vec_add
            expected_str: "mem_traces:"
            name: mem_trace
            server_timeout: 15

    steps:
      - name: Configure proxy for China
        run: |
          echo "Setting up proxy for China network..."
          export http_proxy=http://192.168.15.1:2345
          export https_proxy=http://192.168.15.1:2345
          export HTTP_PROXY=http://192.168.15.1:2345
          export HTTPS_PROXY=http://192.168.15.1:2345
          export no_proxy=localhost,127.0.0.1,192.168.0.0/16
          echo "http_proxy=http://192.168.15.1:2345" >> $GITHUB_ENV
          echo "https_proxy=http://192.168.15.1:2345" >> $GITHUB_ENV
          echo "HTTP_PROXY=http://192.168.15.1:2345" >> $GITHUB_ENV
          echo "HTTPS_PROXY=http://192.168.15.1:2345" >> $GITHUB_ENV
          echo "no_proxy=localhost,127.0.0.1,192.168.0.0/16" >> $GITHUB_ENV
          git config --global --add http.proxy http://192.168.15.1:2345
          git config --global --add https.proxy http://192.168.15.1:2345

      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Check and install required tools
        run: |
          echo "Checking installed tools..."
          sudo apt-get update -y
          sudo apt-get install -y build-essential llvm-dev llvm-18-dev cmake \
            libboost-all-dev libzstd-dev pkg-config ninja-build \
            libelf-dev zlib1g-dev libcurl4-openssl-dev \
            clang clang-18
          
          # Check CUDA
          nvcc --version || echo "nvcc not found (CUDA compiler)"
          echo "CUDA location: $(which nvcc)"

      - name: Build bpftime with CUDA support (LLVM JIT)
        shell: bash
        run: |
          set -e
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBPFTIME_LLVM_JIT=YES \
            -DBPFTIME_ENABLE_CUDA_ATTACH=ON \
            -DBPFTIME_CUDA_ROOT="/usr/local/cuda-12.6" \
            -DLLVM_DIR="/usr/lib/llvm-18/lib/cmake/llvm/" \
            -G Ninja
          cmake --build build --config Debug --target bpftime-agent bpftime-syscall-server -j$(nproc) --verbose -- -v | tee build_llvm_verbose.log

      - name: Build GPU example
        run: |
          echo "Building GPU example: ${{matrix.examples.path}}"
          # Prefer system clang; fallback to clang-18 if needed
          if ! command -v clang >/dev/null 2>&1 && command -v clang-18 >/dev/null 2>&1; then
            export CLANG=clang-18
          fi
          make -C example/gpu/${{matrix.examples.path}} -j

      - name: Test GPU example (per README two-process)
        shell: bash
        run: |
          set -e
          cd example/gpu/${{matrix.examples.path}}
          BUILD_DIR=$(cd ../../../build && pwd)
          SERVER_SO="$BUILD_DIR/runtime/syscall-server/libbpftime-syscall-server.so"
          AGENT_SO="$BUILD_DIR/runtime/agent/libbpftime-agent.so"
          echo "Launching server with $SERVER_SO"
          BPFTIME_SHM_MEMORY_MB=1000 BPFTIME_LOG_OUTPUT=console LD_PRELOAD="$SERVER_SO" \
            "${{matrix.examples.executable}}" > server.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          sleep 3
          echo "Launching client with $AGENT_SO: ${'${{matrix.examples.victim}}'}"
          BPFTIME_LOG_OUTPUT=console LD_PRELOAD="$AGENT_SO" \
            ${'${{matrix.examples.victim}}'} > client.log 2>&1 || true
          echo "Checking expected output: ${'${{matrix.examples.expected_str}}'}"
          if grep -Fq "${'${{matrix.examples.expected_str}}'}" server.log client.log; then
            echo "SUCCESS: expected string found"
            RESULT=0
          else
            echo "FAILURE: expected string not found"
            echo "--- server.log (tail) ---"; tail -n 200 server.log || true
            echo "--- client.log (tail) ---"; tail -n 200 client.log || true
            RESULT=1
          fi
          kill $SERVER_PID 2>/dev/null || true
          exit $RESULT


